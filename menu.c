#include <conio.h>
#include <dos.h>
#include <stdio.h>

#define KEY_UP 72
#define KEY_DOWN 80
#define KEY_LEFT 75
#define KEY_RIGHT 77
#define ESC 27
#define ENTER 13

unsigned char Color_S = 0x0F; 
unsigned char Color_N = 0x0F;
unsigned char Color_W = 0x70;
unsigned char Color_E = 0x0F;
unsigned char CARD = 0;
unsigned char *TILE_MAP = (unsigned char *)0xB8000000L;
unsigned char *TILE_MAP_IMAGE;// this points to ASCII image in VRAM
unsigned char *TILE_MAP_ROWS[16];// this points to name rows in VRAM
unsigned char MAP_RLE[] = {
	0x02,0x00,0x00,0x02,0xDB,0x08,0x02,0xDB,0x07,0x44,0xDB,0x0F,0x02,0xDB,0x07,0x02,
	0xDB,0x08,0x55,0x00,0x00,0x01,0xDB,0x1F,0x01,0xDF,0x1F,0x02,0xDF,0x1E,0x02,0xDF,
	0x1A,0x02,0xDF,0x13,0x02,0xDF,0x19,0x17,0xDF,0x18,0x01,0xDB,0x08,0x2E,0x00,0x00,
	0x01,0xDB,0x0E,0x20,0x00,0x01,0x01,0xDB,0x08,0x2E,0x00,0x00,0x01,0xDB,0x1A,0x20,
	0x00,0x01,0x01,0xDB,0x08,0x2E,0x00,0x00,0x01,0xDB,0x03,0x20,0x00,0x01,0x01,0xDB,
	0x09,0x2E,0x00,0x00,0x01,0xDB,0x09,0x20,0x00,0x01,0x01,0xDB,0x03,0x2E,0x00,0x00,
	0x01,0xDB,0x08,0x20,0x00,0x01,0x01,0xDB,0x0A,0x2E,0x00,0x00,0x01,0xDB,0x08,0x20,
	0x00,0x01,0x01,0xDB,0x0E,0x2E,0x00,0x00,0x01,0xDB,0x08,0x20,0x00,0x01,0x01,0xDB,
	0x0E,0x2E,0x00,0x00,0x01,0xDB,0x08,0x20,0x00,0x01,0x01,0xDB,0x0A,0x2E,0x00,0x00,
	0x01,0xDB,0x08,0x20,0x00,0x01,0x01,0xDB,0x03,0x2E,0x00,0x00,0x01,0xDB,0x08,0x20,
	0x00,0x01,0x01,0xDB,0x09,0x2E,0x00,0x00,0x01,0xDB,0x08,0x20,0x00,0x01,0x01,0xDB,
	0x08,0x2E,0x00,0x00,0x01,0xDB,0x08,0x20,0x00,0x01,0x01,0xDB,0x08,0x2E,0x00,0x00,
	0x01,0xDB,0x08,0x20,0x00,0x01,0x01,0xDB,0x09,0x2E,0x00,0x00,0x01,0xDB,0x08,0x20,
	0x00,0x01,0x01,0xDB,0x03,0x2E,0x00,0x00,0x01,0xDB,0x08,0x20,0x00,0x01,0x01,0xDB,
	0x0A,0x2E,0x00,0x00,0x01,0xDB,0x09,0x20,0x00,0x01,0x01,0xDB,0x0E,0x2E,0x00,0x00,
	0x01,0xDB,0x03,0x01,0xDC,0x13,0x02,0xDC,0x19,0x14,0xDC,0x18,0x02,0xDC,0x19,0x02,
	0xDC,0x13,0x02,0xDC,0x1A,0x02,0xDC,0x1E,0x01,0xDC,0x0F,0x01,0xDB,0x0F,0x7C,0x00,
	0x00,0x01,0xDF,0x78,0x4C,0xDF,0x08,0x01,0xDF,0x78,0x02,0x00,0x00,0x01,0xDB,0x0F,
	0x4C,0x00,0x0F,0x01,0xDB,0x0F,0x02,0x00,0x00,0x01,0xDB,0x0F,0x4C,0x00,0x0F,0x01,
	0xDB,0x0F,0x02,0x00,0x00,0x01,0xDC,0x78,0x4C,0xDC,0x08,0x01,0xDC,0x78,0x01,0x00,
	0x00,
};

char path[100][150], executable[100][150], name[100][150];

void Clearkb(){
	asm mov ah,00ch
	asm mov al,0
	asm int 21h
}

void Check_Graphics(){
	int i;
	union REGS regs;
	regs.h.ah=0x1A; regs.h.al=0x00; regs.h.bl=0x32;
	int86(0x10, &regs, &regs);
	if (regs.h.al == 0x1A) CARD = 1;
	else {
		regs.h.ah=0x12; regs.h.bh=0x10;regs.h.bl=0x10;
		int86(0x10, &regs, &regs);
		if (regs.h.bh == 0) CARD = 1;
		else {
			regs.h.ah=0x0F; regs.h.bl=0x00;
			int86(0x10, &regs, &regs);
			if (regs.h.al == 0x07) CARD = 0;
			else CARD = 1;
		}
	}	
	if (CARD) {//CGA TANDY EGA VGA
		Color_S = 0x3F; Color_N = 0x1F; Color_E = 0x4F; TILE_MAP_IMAGE = (unsigned char *)0xB8000000L;
		for (i =0;i<16;i++)TILE_MAP_ROWS[i] = (unsigned char *)0xB8000000L+((i+3)*160);
	}
	else {//MDA
		Color_S = 0x70; Color_N = 0x10; Color_E = 0x10; TILE_MAP_IMAGE = (unsigned char *)0xB0000000L;
		for (i =0;i<16;i++)TILE_MAP_ROWS[i] = (unsigned char *)0xB0000000L+((i+3)*160);
	}
}

int load() {
    char str[150];
    int j=0;
    FILE* fp;
    fp = fopen("LIST.TXT", "r");
    while (fgets(str, 150, fp)) {
        // skip comments
        if(str[0] == '#') {
            continue;
        }
        sscanf(str,"%s\t%s\t%*s\t%*s\t%[^\n]", &path[j], &executable[j], &name[j]);
        j++;
    }
    fclose(fp);
    return j;
}

void Draw_Menu(){
	int offset = 0;
	int rle = 0;
	int k = 0;
	while (offset < 160*25){
		unsigned char number = MAP_RLE[rle];
		unsigned char glyph = MAP_RLE[rle+1];
		unsigned char col = MAP_RLE[rle+2];
		for (k = 0; k < number; k++){
			TILE_MAP[offset++] = glyph;
			TILE_MAP[offset++] = col;
		}
		rle+=3;
		//if (CARD == 0)
	}
	gotoxy(29,1);
	textattr(Color_W);
	cprintf("LOADER MENU   FOR PCXT");
	gotoxy(16,23);
	textattr(Color_N);
	cprintf("Select using cursors [ESC to exit, ENTER to run]");
}

int main() {
    int programs;
    int i = 0, scroll = 0;
    int selected = 0;
    int exit = 0;
    char input;
	system("cls");
	Check_Graphics();
	Draw_Menu();
	programs = load();
    while(!exit) {
		TILE_MAP_ROWS[selected-1][4] = ' ';
		TILE_MAP_ROWS[selected  ][4] = '>';
		TILE_MAP_ROWS[selected+1][4] = ' ';

        for (i = 0; i < 16; i++) {
            if (i + scroll < programs) {
				unsigned char c = 0x0F;
				int k = 0;
				if (i == selected) c = Color_S;
				else c = Color_N;
				for (k = 4; k < 36; k++){
					TILE_MAP_ROWS[i][(k<<1)] = name[i + scroll][k-4];
					TILE_MAP_ROWS[i][(k<<1)+1] = c;
				}
            }
        }
        if (kbhit()){
			input = getch();
			switch (input){
				case ESC: exit = 1; break;
				case 0:
					input = getch();
					if (input == KEY_DOWN){
						if(selected == 15) {
							if (scroll + 15 < programs) scroll++;
						} else selected++;
					}
					if (input == KEY_UP) {
						if(selected == 0) {
							if(scroll > 0)scroll--;
						} else selected--;
					}
				break;
				case ENTER:
					gotoxy(4,23);
					textattr(Color_N);
					cprintf("Executing %s", executable[selected + scroll]);
					printf(" ");
					chdir(path[selected+scroll]);
					system(executable[selected + scroll]);
				break;
			}
			
		}
		input = 0;
		Clearkb();
    }
	system("cls");
    return 0;
}